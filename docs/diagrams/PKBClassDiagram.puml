@startuml
skinparam classAttributeIconSize 0

class SP
class QPS
class PKB

abstract class IPKBPopulator {
	+void populate(Vector<Entity *>)
    +void populate(Vector<Relationship *>)
    +void populate(Vector<Pattern *>)
}

abstract class IPKBQuerier {
	+EntityPointerUnorderedSet getEntities(EntityType)
	+EntityPointerUnorderedSet getByRelationship(RsType, Entity *, bool)
	+EntityPointerUnorderedSet getByPattern(Entity *, String, bool)
	+EntityPointerUnorderedSet getEntities(String)
}

class PKB {
    -EntityManager entity_manager_
    -PatternManager pattern_manager_
    -RelationshipManager relationship_manager_
	+void populate(Vector<Entity *>)
    +void populate(Vector<Relationship *>)
    +void populate(Vector<Pattern *>)
	+EntityPointerUnorderedSet getEntities(EntityType)
	+EntityPointerUnorderedSet getByRelationship(RsType, Entity *, bool)
	+EntityPointerUnorderedSet getByPattern(Entity *, String, bool)
	+EntityPointerUnorderedSet getEntities(String)
}

class EntityManager {
    -unordered_map entity_table_map_ 
    -void CreateTable(EntityType)
    +EntityTable* GetTable(EntityType) 
    +void Populate(Vector<Entity *>)
    +EntityPointerUnorderedSet Get(EntityType)
    +EntityPointerUnorderedSet Get(String)
}

class RelationshipManager {
    -Cache *cache_
    -unordered_map relationship_table_map_
    -void CreateTable(RsType)
    -void GetAffectsHelper(PriorityQueue<Pair<Entity *, EntityPointerUnorderedSet>> *, EntityPointerUnorderedSet *, EntityPointerUnorderedSet *)
    -void GetAffectsInverseHelper(PriorityQueue<Pair<Entity *, EntityPointerUnorderedSet>> *, EntityPointerUnorderedSet *, EntityPointerUnorderedSet *)
    -bool IsVariableModified(EntityPointerUnorderedSet *, Entity *)
    -bool IsVariableUsed(EntityPointerUnorderedSet *, Entity*)
    -bool IsEntityInWhileLoop(Entity *)
    -Entity* GetProcedureEntity(Entity *, bool)
    -EntityPointerUnorderedSet GetAffects(Entity *, bool)
    -EntityPointerUnorderedSet GetCalls(Entity *, bool)
    -EntityPointerUnorderedSet GetInference(RsType, Entity *, bool)
    -EntityPointerUnorderedSet GetInferenceFromChildren(RelationshipTable *, Entity *)
    -EntityPointerUnorderedSet GetInferenceGivenCallStatement(RelationshipTable *, Entity *)
    -EntityPointerUnorderedSet GetInferenceGivenVariable(RelationshipTable *, Entity *)
    -EntityPointerUnorderedSet GetSubMatches(RsType, Entity *, bool) 
    -EntityPointerUnorderedSet Empty()
    -EntityRsInv GetCacheQuery(Entity *, RsType, bool)
    +void ClearCache()
    +RelationshipTable* GetTable(RsType)
    +void Populate(Vector<Relationship *>) 
    +EntityPointerUnorderedSet Get(RsType, Entity *, bool)
    +EntityPointerUnorderedSet GetAll(RsType, Entity *, bool)
}

class PatternManager {
    -PatternTable *pattern_table_
    +PatternTable* GetTable()
    +void Populate(Vector<Pattern *>)
    +EntityPointerUnorderedSet Get(Entity *, String, bool)
}

class RelationshipTable {
    #EntityPointerUnorderedMap table_
    #EntityPointerUnorderedMap inverse_table_
    -EntityPointerUnorderedSet Empty()
    +void Populate(Relationship)
    +EntityPointerUnorderedMap GetTable(bool)
    +EntityPointerUnorderedSet get(Entity *, bool) 
}

class EntityTable {
    #EntityPointerUnorderedSet table_
    +void Populate(Entity)
    +EntityPointerUnorderedSet get()
}

class PatternTable {
    -PatternEntityUnorderedMap pattern_table_
    +void Populate(Pattern)
    +PatternEntityUnorderedMap GetTable()
    +EntityPointerUnorderedSet Get(Entity *)
}

class Cache {
    -int hits_
    -int misses_
    -int capacity_
    -List<Pair<K, V>> access_list_
    -unordered_map<K, List<Pair<K,V>>, KHash> map_
    -void UpdateAccess(K)
    -void Evict()
    +void Add(K, V)
    +Result Get(K)
    +void Clear()
    +int Size()
    +int Hits()
    +int Misses()
}

struct Result {
    +V value
    +bool found
}

abstract class "QueryPattern"

class VariableTable {
}

class ReadTable {
}

class PrintTable {
}

class CallTable {
}

class IfTable {
}

class WhileTable {
}

class ConstantTable {
}

class ProcedureTable {
}

class AssignTable {
}

class ModifiesTable {
}

class FollowsTable {
}  

class UsesTable {
}

class ParentTable {
} 

class CallsTable {
} 

class NextTable {
} 

IPKBPopulator *-down- PKB
IPKBQuerier *-down- PKB
SP -down- IPKBPopulator
QPS -down- IPKBQuerier

PKB <|.down EntityManager
PKB <|.down.  PatternManager
PKB <|.down.. RelationshipManager

EntityTable -up-* EntityManager

VariableTable -up-|> EntityTable
ReadTable -up-|> EntityTable
PrintTable -up-|> EntityTable
CallTable -up-|> EntityTable
IfTable -up-|> EntityTable
WhileTable -up-|> EntityTable
ConstantTable -up-|> EntityTable
ProcedureTable -up-|> EntityTable
AssignTable -up-|> EntityTable

RelationshipTable -up-* RelationshipManager 

ModifiesTable -up-|> RelationshipTable
FollowsTable -up-|> RelationshipTable 
UsesTable -up-|> RelationshipTable
ParentTable -up-|> RelationshipTable 
CallsTable -up-|> RelationshipTable 
NextTable -up-|> RelationshipTable 

PatternTable -up-* PatternManager
PatternTable -down-|> QueryPattern

Result -up-* Cache

@enduml